  name: "Unmanaged dependency check"
  description: "Checks whether there's a dependency that is not managed by java shared dependencies."
  inputs:
    bom-path:
      description: "The relative path from the repository root to the pom.xml file"
      required: true
  runs:
    using: "composite"
    steps:
    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 11
        cache: maven
    - name: Set up Maven
      uses: stCarolas/setup-maven@v4.5
      with:
        maven-version: 3.8.2
    - name: Retrieve latest released version of Java shared dependencies
      shell: bash
      run: |
        version=$(git tag -l 'google-cloud-shared-dependencies/v*' --sort=-v:refname | head -1) 
        echo "short_version=${version#*v}" >> $GITHUB_ENV
    - name: Install check
      shell: bash
      run: |
        cd ${{ github.action_path }}
        echo "Install Unmanaged Dependency Check in $(pwd)"
        mvn clean install -V --batch-mode --no-transfer-progress -DskipTests
    - name: Run unmanaged dependency check
      shell: bash
      run: |
        bom_absolute_path=$(realpath "${{ inputs.bom-path }}")
        cd ${{ github.action_path }}
        echo "The version of Java shared dependencies is ${{ env.short_version }}"
        echo "Running Unmanaged Dependency Check against ${bom_absolute_path}"
        unmanaged_dependencies=$(mvn exec:java -Dexec.args="${{ env.short_version }} ${bom_absolute_path}" -q)
        if [[ "${unmanaged_dependencies}" != "[]" ]]; then
          echo "Unmanaged dependencies, ${unmanaged_dependencies}, found in ${{ inputs.bom-path }}."
          echo "Please follow go/add-dependency-to-cloud-sdk-java to add a third-party dependency."
          exit 1
        fi

